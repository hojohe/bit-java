package kr.co.mini5.user.servlet;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.oreilly.servlet.MultipartRequest;

import kr.co.mini5.user.dao.UserDAO;
import kr.co.mini5.vo.UserVO;

@WebServlet("/user/userUpdate")
public class UserUpdateServlet extends HttpServlet{

	@Override
	protected void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
		request.setCharacterEncoding("utf-8");
		
		UserDAO dao = new UserDAO ();
		
		
		ServletContext context = request.getServletContext();
		String path = context.getRealPath("/upload");
		
		SimpleDateFormat sdf = new SimpleDateFormat("/yyyy/MM/dd");
		String datePath = sdf.format(new Date());
		
		String savePath = path + datePath;
		File f = new File(savePath);
		if (!f.exists()) f.mkdirs();
		
		MultipartRequest mRequest = new MultipartRequest(
				request, 
				savePath, 
				1024 * 1024 * 10, 
				"UTF-8",
				new kr.co.mini5.common.file.MlecFileRenamePolicy()
		);
		
		String id = mRequest.getParameter("id");
		String pass = mRequest.getParameter("pass");
		String newPass = mRequest.getParameter("newpass");
		String passConfirm = mRequest.getParameter("passConfirm");
		
		System.out.println("ddd1"+id);
		System.out.println("ddd2"+pass);
		System.out.println("ddd3"+newPass);
		
		
		UserVO param = new UserVO();
		param.setId(id);
		param.setPass(pass);
		
		UserVO resultVO = dao.selectUserPassList(param);
		
		if(resultVO == null) {
			
			request.setAttribute("msg", "현재 비밀번호가 틀렸습니다. 다시 입력해주세요.");	
			RequestDispatcher rd = request.getRequestDispatcher("/jsp/view/user/userDetail.jsp");
			rd.forward(request, response);
			
		}else{
			
			File file = mRequest.getFile("imgfind1");
			File file2 = mRequest.getFile("imgfind2");
			
			
			UserVO param2 = new UserVO();
			param2.setId(id);
			param2.setPass(newPass);
			
			// 프로필 이미지 
			if (file != null) {
//				String oriaName = mRequest.getOriginalFileName("imgfind1");
				String imgProf = mRequest.getFilesystemName("imgfind1");
				param2.setProfImgPath(datePath + "/" + imgProf);
			}	
			
			// 커버 이미지
			if (file2 != null) {
//				String oribName = mRequest.getOriginalFileName("imgfind2");
				String imgCovr = mRequest.getFilesystemName("imgfind2");
				param2.setCovrImgPath(datePath + "/" + imgCovr);
			}
			
			dao.updateUserProf(param2);
			
			request.setAttribute("msg", "회원정보가 정상적으로 수정되었습니다.");
			RequestDispatcher rd = request.getRequestDispatcher("/jsp/view/user/userDetail.jsp");
			rd.forward(request, response);
			
			
		}
		
		
			
		
		
	}
}
