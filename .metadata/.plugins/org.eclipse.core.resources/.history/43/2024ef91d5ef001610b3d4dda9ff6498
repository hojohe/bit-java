package kr.co.mini5.user.servlet;

import java.io.IOException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import kr.co.mini5.user.dao.UserDAO;
import kr.co.mini5.vo.UserVO;

@WebServlet("/userSignUp/userSignUp")
public class UserSignUpServlet extends HttpServlet{
	
	UserDAO dao = new UserDAO();
	
	@Override
	public void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {

		request.setCharacterEncoding("utf-8");

		UserVO param = new UserVO();
		
		/* UserSingUp.jsp 파일에서 <form> 태그로 넘겨준 값들 (id, pass, nickName)*/
		String id = request.getParameter("id");
		String pass = request.getParameter("pass");
		String nickName = request.getParameter("nickName");
	
		/**/
		String dbUserId = dao.selectUserIdList(id);
		
		if(id.equals(dbUserId)) {
			
			System.out.println("아이디 중복");
			request.setAttribute("msg", "아이디가 중복됩니다.");
			RequestDispatcher rd = request.getRequestDispatcher("/jsp/view/user/userSignUpForm.jsp");
			rd.forward(request, response);
			
		} else {
			param.setId(id);
			param.setPass(pass);
			param.setNickName(nickName);
			
			// 회원가입
			int userNo = dao.insertUser(param);
			System.out.println("회원가입 1" + id);
			System.out.println("회원가입 2" + pass);
			System.out.println("회원가입 3" + nickName);
			// 회원가입 한 사용자 정보 조회
			UserVO user = dao.selectSignUp(userNo);
			HttpSession session = request.getSession();
			session.setAttribute("user", user);
			RequestDispatcher rd = request.getRequestDispatcher("/jsp/view/user/userSignUpForm.jsp");
			rd.forward(request, response);
			response.sendRedirect(request.getContextPath()+"/jsp/main/main2.jsp?user=" + user);
		}
		
		
	}
		
}
